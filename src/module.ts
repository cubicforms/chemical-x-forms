import {
  addImportsDir,
  addPlugin,
  addTypeTemplate,
  createResolver,
  defineNuxtModule
} from "@nuxt/kit"
import { inputTextAreaNodeTransform } from "~/lib/core/transforms/input-text-area-transform"
import { selectNodeTransform } from "~/lib/core/transforms/select-transform"

// Module options TypeScript interface definition
// eslint-disable-next-line @typescript-eslint/no-empty-object-type
export interface ModuleOptions {}

export default defineNuxtModule<ModuleOptions>({
  meta: {
    name: "chemical-x-forms",
    configKey: "chemicalX",
  },
  defaults: {},
  setup(_options, _nuxt) {
    _nuxt.options.vue.compilerOptions.nodeTransforms ||= []
    _nuxt.options.vue.compilerOptions.nodeTransforms.push(
      selectNodeTransform,
      inputTextAreaNodeTransform
    )

    const resolver = createResolver(import.meta.url)
    addImportsDir(resolver.resolve("./runtime/composables"))

    addPlugin({
      src: resolver.resolve("./runtime/plugins/xmodel"),
      mode: "client",
    })

    addPlugin({
      src: resolver.resolve("./runtime/plugins/xmodel-stub"),
      mode: "server",
    })

    // v-xmodel directive type
    addTypeTemplate({
      filename: "types/v-xmodel.d.ts",
      getContents: () => `// Generated by @chemical-x/forms
import type { ObjectDirective } from "vue"
import type { VXmodelDirective } from "./runtime/plugins/xmodel.ts"

declare module "vue" {
  interface GlobalDirectives { 
    vXmodel: ObjectDirective<HTMLElement, VXmodelDirective>
  }
}

export { }`,
    })
  },
})
